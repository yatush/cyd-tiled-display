esphome:
  includes:
    - lib/draw_state.h
    - lib/utils.h
    - lib/tiles.h
    - lib/screens.h
    - lib/view.h

packages:
  common: !include lib_common.yaml

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

time:
  - platform: homeassistant
    id: esptime

ld2410:
  id: ld2410_radar

switch:
  - platform: ld2410
    engineering_mode:
      name: "engineering mode"
    bluetooth:
      name: "control bluetooth"

number:
  - platform: ld2410
    timeout: { name: Radar Timeout }
    max_move_distance_gate: { name: Radar Max Move Distance }
    max_still_distance_gate: { name: Radar Max Still Distance }
    light_threshold: { name: light threshold }
    g0:
      move_threshold: { name: g0 move threshold, id: g0m }
      still_threshold: { name: g0 still threshold, id: g0s }
    g1:
      move_threshold: { name: g1 move threshold, id: g1m }
      still_threshold: { name: g1 still threshold, id: g1s }
    g2:
      move_threshold: { name: g2 move threshold, id: g2m }
      still_threshold: { name: g2 still threshold, id: g2s }
    g3:
      move_threshold: { name: g3 move threshold, id: g3m }
      still_threshold: { name: g3 still threshold, id: g3s }
    g4:
      move_threshold: { name: g4 move threshold, id: g4m }
      still_threshold: { name: g4 still threshold, id: g4s }
    g5:
      move_threshold: { name: g5 move threshold, id: g5m }
      still_threshold: { name: g5 still threshold, id: g5s }
    g6:
      move_threshold: { name: g6 move threshold, id: g6m }
      still_threshold: { name: g6 still threshold, id: g6s }
    g7:
      move_threshold: { name: g7 move threshold, id: g7m }
      still_threshold: { name: g7 still threshold, id: g7s }
    g8:
      move_threshold: { name: g8 move threshold, id: g8m }
      still_threshold: { name: g8 still threshold, id: g8s }

light:
  - platform: rgb
    name: LED
    id: led
    red: output_red
    green: output_green
    blue: output_blue
    restore_mode: ALWAYS_OFF

button:
  - platform: restart
    name: "Restart EPS32"
    id: restart_button

binary_sensor:
  - platform: ld2410
    has_target:
      name: Radar Target
      id: radar_has_target
    has_moving_target:
      name: Radar Moving Target
      id: radar_has_moving_target
      on_state:
        then:
          - script.execute: on_movement
    has_still_target:
      name: Radar Still Target


sensor:
  - platform: wifi_signal # Reports the WiFi signal strength in %
    name: "WiFi Signal Percent"
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
      - delta: 5.0
    unit_of_measurement: "Signal %"
    id: wifi_signal_pct
    update_interval: 1s
    entity_category: "diagnostic"

  - platform: copy
    source_id: board_ldr
    id: board_ldr_p
    name: "Ambient Light"
    filters:
      - lambda: return min(max((100 - (((x - 0.075) / (1.039 - 0.075)) * 100)), 0.0), 100.0);
      - delta: 5.0
    unit_of_measurement: "%"
    accuracy_decimals: 0

  - platform: ld2410
    moving_distance: { name: Radar Moving Distance, id: moving_distance }
    still_distance: { name: Radar Still Distance, id: still_distance }
    moving_energy: { name: Radar Move Energy }
    still_energy: { name: Radar Still Energy }
    detection_distance:
      { name: Radar Detection Distance, id: radar_detection_distance }
    light: { name: Radar Light, id: radar_light }
    g0:
      {
        move_energy: { name: g0 move energy },
        still_energy: { name: g0 still energy },
      }
    g1:
      {
        move_energy: { name: g1 move energy },
        still_energy: { name: g1 still energy },
      }
    g2:
      {
        move_energy: { name: g2 move energy },
        still_energy: { name: g2 still energy },
      }
    g3:
      {
        move_energy: { name: g3 move energy },
        still_energy: { name: g3 still energy },
      }
    g4:
      {
        move_energy: { name: g4 move energy },
        still_energy: { name: g4 still energy },
      }
    g5:
      {
        move_energy: { name: g5 move energy },
        still_energy: { name: g5 still energy },
      }
    g6:
      {
        move_energy: { name: g6 move energy },
        still_energy: { name: g6 still energy },
      }
    g7:
      {
        move_energy: { name: g7 move energy },
        still_energy: { name: g7 still energy },
      }
    g8:
      {
        move_energy: { name: g8 move energy },
        still_energy: { name: g8 still energy },
      }

script:
  - id: init_radar
    then:
      - lambda: |-
          static const struct { esphome::ld2410::GateThresholdNumber* gate; int val; } values[] = {
            {id(g0m), 50}, {id(g1m), 50}, {id(g2m), 40}, {id(g3m), 40}, {id(g4m), 40},
            {id(g5m), 40}, {id(g6m), 30}, {id(g7m), 30}, {id(g8m), 30},
            {id(g0s), 0},  {id(g1s), 0},  {id(g2s), 40}, {id(g3s), 40}, {id(g4s), 40},
            {id(g5s), 40}, {id(g6s), 15}, {id(g7s), 15}, {id(g8s), 15}
          };
          for (auto &v : values)
            v.gate->make_call().set_value(v.val).perform();

  - id: adapt_bright
    then:
      - lambda: |-
          auto computed_bright = max(3, static_cast<int>(id(board_ldr_p).state) / 10) / 10.0;
          if (computed_bright <= 0.8 && id(backlight).remote_values.is_on()) {
            computed_bright = max(0.3, computed_bright - 0.2);
          }
          // Do at most 0.1 steps.
          auto current_bright = id(backlight).remote_values.get_brightness();
          auto delta = min(0.1, max(-0.1, computed_bright - current_bright));
          id(backlight).make_call().set_brightness(current_bright + delta).perform();